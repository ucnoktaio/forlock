# Forlock - Single Node Deployment
#
# Usage:
#   1. Copy .env.example to .env
#   2. Run: ./scripts/generate-secrets.sh
#   3. Run: docker compose up -d
#
# Requirements:
#   - Docker 24+
#   - Docker Compose v2
#   - Minimum 2GB RAM

services:
  # ==========================================
  # Database Services
  # ==========================================

  postgres:
    image: postgres:15-alpine
    container_name: forlock-postgres
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-forlock}
      POSTGRES_USER: ${POSTGRES_USER:-vault_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-vault_user} -d ${POSTGRES_DB:-forlock}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M

  redis:
    image: redis:7-alpine
    container_name: forlock-redis
    restart: always
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:?REDIS_PASSWORD is required}
      --maxmemory 256mb
      --maxmemory-policy volatile-lru
      --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - internal
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  rabbitmq:
    image: rabbitmq:3.13-alpine
    container_name: forlock-rabbitmq
    restart: always
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-forlock}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:?RABBITMQ_PASSWORD is required}
      RABBITMQ_DEFAULT_VHOST: forlock
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - internal
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # ==========================================
  # Application Services
  # ==========================================

  api:
    image: ucnokta/forlock-api:${IMAGE_TAG:-latest}
    container_name: forlock-api
    restart: always
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: "true"

      # Database
      Database__Provider: PostgreSQL
      ConnectionStrings__DefaultConnection: Host=postgres;Port=5432;Database=${POSTGRES_DB:-forlock};Username=${POSTGRES_USER:-vault_user};Password=${POSTGRES_PASSWORD};Pooling=true;MinPoolSize=5;MaxPoolSize=50

      # JWT
      Authentication__Jwt__SecretKey: ${JWT_SECRET_KEY:?JWT_SECRET_KEY is required}
      Authentication__Jwt__Issuer: ${JWT_ISSUER:-forlock-api}
      Authentication__Jwt__Audience: ${JWT_AUDIENCE:-forlock-clients}
      Authentication__Jwt__ExpirationMinutes: ${JWT_EXPIRATION_MINUTES:-480}

      # Encryption
      VAULT_MASTER_KEY: ${VAULT_MASTER_KEY:?VAULT_MASTER_KEY is required}
      SYSTEM_MASTER_KEY: ${SYSTEM_MASTER_KEY:?SYSTEM_MASTER_KEY is required}

      # Vault disabled
      Vault__Enabled: "false"

      # Security
      Security__EnableMFA: "true"
      Security__EnableHardwareKeys: "true"

      # Redis
      Redis__Enabled: "true"
      Redis__ConnectionString: redis:6379,password=${REDIS_PASSWORD},ssl=false,abortConnect=false
      ConnectionStrings__Redis: redis:6379,password=${REDIS_PASSWORD},ssl=false,abortConnect=false

      # RabbitMQ
      RabbitMq__Host: rabbitmq
      RabbitMq__VirtualHost: forlock
      RabbitMq__Username: ${RABBITMQ_USER:-forlock}
      RabbitMq__Password: ${RABBITMQ_PASSWORD}
      RabbitMq__Port: 5672

      # CORS & FIDO2
      Cors__AllowedOrigins: ${CORS_ALLOWED_ORIGINS:-https://localhost}
      Fido2__ServerDomain: ${FIDO2_DOMAIN:-localhost}
      Fido2__ServerName: ${FIDO2_SERVER_NAME:-Forlock}
      Fido2__Origins__0: ${FIDO2_ORIGIN:-https://localhost}

      # Logging
      Serilog__MinimumLevel__Default: ${LOG_LEVEL:-Information}

      # Virtual HSM
      USE_VIRTUAL_HSM: "true"
      TPM_ENABLED: "false"

      # Swagger disabled
      Development__EnableSwagger: "false"
    volumes:
      - api_logs:/var/log/vault
      - dataprotection_keys:/app/.aspnet/DataProtection-Keys
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G

  frontend:
    image: ucnokta/forlock-frontend:${IMAGE_TAG:-latest}
    container_name: forlock-frontend
    restart: always
    networks:
      - internal
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M

  # ==========================================
  # Reverse Proxy
  # ==========================================

  nginx:
    image: ucnokta/forlock-nginx:${IMAGE_TAG:-latest}
    container_name: forlock-nginx
    restart: always
    environment:
      FRONTEND_PORT: 80
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./ssl:/etc/nginx/ssl:ro
      - ./logs/nginx:/var/log/nginx
      - certbot_webroot:/var/www/certbot:ro
      - certbot_certs:/etc/letsencrypt:ro
    depends_on:
      - api
      - frontend
    networks:
      - internal
      - external
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M

  # ==========================================
  # SSL Certificate Management (Optional)
  # ==========================================

  certbot:
    image: certbot/certbot:latest
    container_name: forlock-certbot
    volumes:
      - certbot_webroot:/var/www/certbot
      - certbot_certs:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    profiles:
      - ssl

# ==========================================
# Volumes
# ==========================================
volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:
  api_logs:
  dataprotection_keys:
  certbot_webroot:
  certbot_certs:

# ==========================================
# Networks
# ==========================================
networks:
  internal:
    driver: bridge
    internal: true
  external:
    driver: bridge
