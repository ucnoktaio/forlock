# Forlock - Docker Swarm HA Deployment
#
# Usage:
#   1. Initialize Swarm: docker swarm init --advertise-addr <MANAGER_IP>
#   2. Join workers: docker swarm join --token <token> <manager-ip>:2377
#   3. Generate secrets: ./scripts/generate-secrets.sh --swarm
#   4. Deploy: docker stack deploy -c docker-compose.swarm.yml forlock
#
# Scale:
#   docker service scale forlock_api=6
#
# Requirements:
#   - Docker Swarm mode
#   - Minimum 3 nodes for HA

version: "3.8"

services:
  # ==========================================
  # Database (Manager node only)
  # ==========================================

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: forlock
      POSTGRES_USER: forlock
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
    secrets:
      - postgres_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - backend
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U forlock -d forlock"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ==========================================
  # Redis Cache
  # ==========================================

  redis:
    image: redis:7-alpine
    command: >
      sh -c 'redis-server
      --requirepass "$$(cat /run/secrets/redis_password)"
      --maxmemory 512mb
      --maxmemory-policy volatile-lru
      --appendonly yes'
    secrets:
      - redis_password
    volumes:
      - redis_data:/data
    networks:
      - backend
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # ==========================================
  # RabbitMQ Message Broker
  # ==========================================

  rabbitmq:
    image: rabbitmq:3.13-alpine
    environment:
      RABBITMQ_DEFAULT_USER: forlock
      RABBITMQ_DEFAULT_PASS_FILE: /run/secrets/rabbitmq_password
      RABBITMQ_DEFAULT_VHOST: forlock
    secrets:
      - rabbitmq_password
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - backend
    deploy:
      mode: replicated
      replicas: 1
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ==========================================
  # Application Services (Scalable)
  # ==========================================

  # Vault API (Personal Password Vault - Scalable)
  api:
    image: ucnokta/forlock-api:${IMAGE_TAG:-latest}
    secrets:
      - db_connection_string
      - redis_connection_string
      - rabbitmq_password
      - jwt_secret
      - vault_master_key
      - system_master_key
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: "true"

      # Database (password read from secret file at runtime)
      Database__Provider: PostgreSQL
      ConnectionStrings__DefaultConnection_File: /run/secrets/db_connection_string

      # JWT
      Authentication__Jwt__SecretKey_File: /run/secrets/jwt_secret
      Authentication__Jwt__Issuer: ${JWT_ISSUER:-forlock-api}
      Authentication__Jwt__Audience: ${JWT_AUDIENCE:-forlock-clients}
      Authentication__Jwt__ExpirationMinutes: ${JWT_EXPIRATION_MINUTES:-480}

      # Encryption
      VAULT_MASTER_KEY_FILE: /run/secrets/vault_master_key
      SYSTEM_MASTER_KEY_FILE: /run/secrets/system_master_key

      # Vault disabled
      Vault__Enabled: "false"

      # Security
      Security__EnableMFA: "true"
      Security__EnableHardwareKeys: "true"

      # Redis (password read from secret file at runtime)
      Redis__Enabled: "true"
      Redis__ConnectionString_File: /run/secrets/redis_connection_string

      # RabbitMQ
      RabbitMq__Host: rabbitmq
      RabbitMq__VirtualHost: forlock
      RabbitMq__Username: forlock
      RabbitMq__Password_File: /run/secrets/rabbitmq_password
      RabbitMq__Port: 5672

      # CORS & FIDO2
      Cors__AllowedOrigins: ${CORS_ALLOWED_ORIGINS:-https://localhost}
      Fido2__ServerDomain: ${FIDO2_DOMAIN:-localhost}
      Fido2__ServerName: ${FIDO2_SERVER_NAME:-Forlock}
      Fido2__Origins__0: ${FIDO2_ORIGIN:-https://localhost}

      # Logging
      Serilog__MinimumLevel__Default: Information

      # Virtual HSM
      USE_VIRTUAL_HSM: "true"
      TPM_ENABLED: "false"

      # Swagger disabled
      Development__EnableSwagger: "false"
    volumes:
      - api_logs:/var/log/vault
      - dataprotection_keys:/app/.aspnet/DataProtection-Keys
    networks:
      - backend
      - frontend
    deploy:
      mode: replicated
      replicas: 3
      update_config:
        parallelism: 1
        delay: 30s
        order: start-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # EPRS API (Enterprise Password Rotation System - Scalable)
  eprs-api:
    image: ucnokta/forlock-eprs-api:${IMAGE_TAG:-latest}
    secrets:
      - db_connection_string
      - redis_connection_string
      - rabbitmq_password
      - jwt_secret
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080
      ASPNETCORE_FORWARDEDHEADERS_ENABLED: "true"

      # Database (Phase 3: Separate forlock_eprs database)
      Database__Provider: PostgreSQL
      ConnectionStrings__EprsDatabase_File: /run/secrets/db_connection_string

      # JWT (shared with main API)
      Authentication__Jwt__SecretKey_File: /run/secrets/jwt_secret
      Authentication__Jwt__Issuer: ${JWT_ISSUER:-forlock-api}
      Authentication__Jwt__Audience: ${JWT_AUDIENCE:-forlock-clients}
      Authentication__Jwt__ExpirationMinutes: ${JWT_EXPIRATION_MINUTES:-480}

      # Redis (password read from secret file at runtime)
      Redis__Enabled: "true"
      Redis__ConnectionString_File: /run/secrets/redis_connection_string

      # RabbitMQ
      RabbitMq__Host: rabbitmq
      RabbitMq__VirtualHost: forlock
      RabbitMq__Username: forlock
      RabbitMq__Password_File: /run/secrets/rabbitmq_password
      RabbitMq__Port: 5672

      # CORS
      Cors__AllowedOrigins: ${CORS_ALLOWED_ORIGINS:-https://localhost}

      # Logging
      Serilog__MinimumLevel__Default: Information

      # EPRS-specific features
      EPRS__EnableDiscovery: "true"
      EPRS__EnableRotation: "true"
      EPRS__AgentHeartbeatInterval: "60"
    volumes:
      - eprs_data:/app/data
      - eprs_logs:/var/log/eprs
    networks:
      - backend
      - frontend
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 30s
        order: start-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 10s
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 768M
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      placement:
        constraints:
          - node.role == worker
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # API Gateway (YARP Reverse Proxy - Scalable)
  gateway:
    image: ucnokta/forlock-gateway:${IMAGE_TAG:-latest}
    environment:
      ASPNETCORE_ENVIRONMENT: Production
      ASPNETCORE_URLS: http://+:8080

      # YARP cluster destinations (using Docker Swarm service names)
      ReverseProxy__Clusters__vault-cluster__Destinations__vault-api__Address: http://api:8080
      ReverseProxy__Clusters__eprs-cluster__Destinations__eprs-api__Address: http://eprs-api:8080

      # CORS
      Cors__AllowedOrigins: ${CORS_ALLOWED_ORIGINS:-https://localhost}

      # Logging
      Serilog__MinimumLevel__Default: Information
    networks:
      - backend
      - frontend
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
      rollback_config:
        parallelism: 1
        delay: 5s
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 5s
      placement:
        constraints:
          - node.role == worker
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ==========================================
  # Frontend Service (Scalable)
  # ==========================================

  frontend:
    image: ucnokta/forlock-frontend:${IMAGE_TAG:-latest}
    networks:
      - frontend
    deploy:
      mode: replicated
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
      restart_policy:
        condition: on-failure
        delay: 5s
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # Nginx Load Balancer (Global)
  # ==========================================

  nginx:
    image: ucnokta/forlock-nginx:${IMAGE_TAG:-latest}
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: ingress
      - target: 443
        published: 443
        protocol: tcp
        mode: ingress
    environment:
      FRONTEND_PORT: 80
    volumes:
      - nginx_ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    networks:
      - frontend
    deploy:
      mode: global
      update_config:
        parallelism: 1
        delay: 10s
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M
      restart_policy:
        condition: on-failure
        delay: 5s

# ==========================================
# Secrets (Create before deploying)
# ==========================================
# Create secrets with:
#   echo "value" | docker secret create secret_name -
# Or use generate-secrets.sh --swarm
secrets:
  db_connection_string:
    external: true
  redis_connection_string:
    external: true
  redis_password:
    external: true
  rabbitmq_password:
    external: true
  jwt_secret:
    external: true
  vault_master_key:
    external: true
  system_master_key:
    external: true

# ==========================================
# Networks
# ==========================================
networks:
  backend:
    driver: overlay
    attachable: false
    internal: true
  frontend:
    driver: overlay
    attachable: false

# ==========================================
# Volumes
# ==========================================
volumes:
  postgres_data:
  redis_data:
  rabbitmq_data:
  api_logs:
  eprs_data:
  eprs_logs:
  dataprotection_keys:
  nginx_ssl:
  nginx_logs:
